<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapping Manager</title>
<link rel="stylesheet" href="style.css?v=1.1.0">
</head>
<body>

<!-- Header -->
<div id="header">
  <span class="app-title">🎮 Mapping Manager</span>
  <span class="filename" id="filenameDisplay" data-i18n-title="filename.tooltip" onclick="startFileNameEdit()" style="cursor:pointer">new_mapping.csv</span>
  <input type="text" id="filenameEdit" class="filename" style="display:none;cursor:text;outline:1px solid #5a5aff;width:220px"
    onblur="finishFileNameEdit()" onkeydown="if(event.key==='Enter')this.blur();if(event.key==='Escape'){this.value=fileName;this.blur();}">
  <span class="toolbar-spacer"></span>
  <button class="toolbar-btn" onclick="handleNew()" data-i18n="btn.new">📄 新規</button>
  <button class="toolbar-btn" onclick="openCSV()" data-i18n="btn.openCsv">📂 CSV読込</button>
  <select id="sampleSelect" onchange="loadSampleFile(this.value)"
    style="background:#1e1e2e;color:#9a9a9a;border:1px solid #333;border-radius:6px;padding:5px 8px;font-size:12px;cursor:pointer;max-width:180px">
    <option value="" data-i18n="sample.placeholder">📂 サンプルを開く</option>
  </select>
  <button class="toolbar-btn accent" onclick="saveCSV()" data-i18n="btn.saveCsv">💾 CSV保存</button>
  <span class="toolbar-sep"></span>
  <button class="toolbar-btn accent2" onclick="showExportModal()" data-i18n="btn.export">📄 チートシート出力</button>
  <span class="toolbar-sep"></span>
  <button class="toolbar-btn" id="undoBtn" onclick="undo()" disabled data-i18n="btn.undo">↩ 元に戻す</button>
  <span class="toolbar-sep"></span>
  <select id="controllerSelect" onchange="switchController(this.value)"
    style="background:#1e1e2e;color:#e0e0e0;border:1px solid #444;border-radius:6px;padding:5px 8px;font-size:12px;font-weight:600;cursor:pointer">
    <option value="xbox">🎮 Xbox</option>
    <option value="ps4">🎮 PS4</option>
    <option value="ps5">🎮 PS5</option>
    <option value="switch">🎮 Switch</option>
  </select>
  <span class="toolbar-sep"></span>
  <button class="toolbar-btn" onclick="setLang(currentLang==='ja'?'en':'ja')" id="langBtn" style="font-size:13px">🌐 EN</button>
  <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="handleOpenCSV(event)">
</div>

<!-- Column Headers -->
<div id="col-headers">
  <div class="col-output">👁</div>
  <div class="col-type" style="padding-left:28px" data-i18n="col.type">種別</div>
  <div class="col-name" data-i18n="col.name">名前</div>
  <div class="col-mapping" data-i18n="col.mapping">マッピング</div>
</div>

<!-- Item List -->
<div id="item-list"></div>

<!-- Add Buttons -->
<div id="add-bar">
  <button class="add-btn" style="color:#60a5fa;border-color:#60a5fa" onclick="addItem('mapping')" data-i18n="add.mapping">+ マッピング</button>
  <button class="add-btn" style="color:#f59e0b;border-color:#f59e0b" onclick="addItem('category')" data-i18n="add.category">+ カテゴリ</button>
  <button class="add-btn" style="color:#888;border-color:#888" onclick="addItem('separator')" data-i18n="add.separator">+ セパレーター</button>
  <button class="add-btn" style="color:#c084fc;border-color:#c084fc" onclick="addItem('pagebreak')" data-i18n="add.pagebreak">+ 改ページ</button>
</div>

<!-- Context Menu -->
<div id="ctx-menu"></div>

<!-- Gamepad Input Modal -->
<div class="modal-overlay" id="gamepadModal">
  <div class="modal-box" style="min-width:420px;max-width:500px">
    <div class="modal-title" data-i18n="gp.title">🎮 コントローラ入力待機中</div>
    <div id="gamepadItemName" style="font-size:13px;color:#78f0c0;background:#12121f;border:1px solid #333;border-radius:6px;padding:6px 10px;margin-bottom:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></div>
    <div style="font-size:11px;color:#888;margin-bottom:4px" data-i18n="gp.currentMapping">現在のマッピング:</div>
    <div id="gamepadCurrentMapping" style="background:#1a1a28;border:1px solid #2a2a3a;border-radius:6px;padding:6px 10px;min-height:28px;display:flex;align-items:center;flex-wrap:wrap;gap:2px;margin-bottom:12px">
      <span style="color:#777;font-size:12px" data-i18n="gp.none">なし</span>
    </div>
    <div class="modal-subtitle" data-i18n="gp.instruction">コントローラーのボタンを押してください。同時押しに対応しています。</div>
    <div style="font-size:10px;color:#886;background:#1a1a10;border:1px solid #333;border-radius:4px;padding:4px 8px;margin-bottom:8px" data-i18n-html="gp.paddleHint"></div>
    <div style="font-size:11px;color:#888;margin-bottom:4px" data-i18n="gp.newInput">新しい入力:</div>
    <div id="gamepadDisplay" style="background:#12121f;border:1px solid #333;border-radius:8px;padding:16px;min-height:50px;display:flex;align-items:center;justify-content:center;flex-wrap:wrap;gap:4px;margin-bottom:20px">
      <span style="color:#777;font-size:13px" data-i18n="gp.noInput">入力なし</span>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;align-items:center">
      <button class="modal-btn" style="background:#5a5a6a" onclick="gamepadCancel()"><span data-i18n="gp.cancel">キャンセル</span> <kbd class="kbd-hint">Esc</kbd></button>
      <button class="modal-btn" style="background:#6b7280" onclick="gamepadSkipNext()"><span data-i18n="gp.skip">次へ</span> <kbd class="kbd-hint">Tab</kbd></button>
      <button class="modal-btn" style="background:#2563eb" onclick="gamepadApply()"><span data-i18n="gp.apply">適用</span> <kbd class="kbd-hint">Enter</kbd></button>
      <button class="modal-btn" style="background:#16a34a" onclick="gamepadApplyNext()"><span data-i18n="gp.applyNext">適用して次へ</span> <kbd class="kbd-hint">Space</kbd></button>
    </div>
  </div>
</div>

<!-- Keyboard Input Modal -->
<div class="modal-overlay" id="keyboardModal">
  <div class="modal-box" style="min-width:520px;max-width:600px">
    <div class="modal-title" data-i18n="kb.title">⌨️ キーボード入力</div>
    <div id="kbItemName" style="font-size:13px;color:#78f0c0;background:#12121f;border:1px solid #333;border-radius:6px;padding:6px 10px;margin-bottom:8px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></div>
    <div style="font-size:11px;color:#888;margin-bottom:4px" data-i18n="kb.currentMapping">現在のマッピング:</div>
    <div id="kbCurrentMapping" style="background:#1a1a28;border:1px solid #2a2a3a;border-radius:6px;padding:6px 10px;min-height:28px;display:flex;align-items:center;flex-wrap:wrap;gap:2px;margin-bottom:8px">
      <span style="color:#777;font-size:12px" data-i18n="kb.none">なし</span>
    </div>
    <!-- New Input Display -->
    <div style="font-size:11px;color:#888;margin-bottom:4px" data-i18n="kb.newInput">新しい入力:</div>
    <div id="kbDisplay" style="background:#12121f;border:1px solid #333;border-radius:8px;padding:10px;min-height:40px;display:flex;align-items:center;justify-content:center;flex-wrap:wrap;gap:4px;margin-bottom:10px">
      <span style="color:#777;font-size:13px" data-i18n="kb.noInput">入力なし</span>
    </div>
    <!-- Key grid -->
    <div style="display:flex;flex-direction:column;gap:3px;margin-bottom:10px">
      <!-- Row: Esc, Numbers, BS -->
      <div class="kb-row">
        <button class="kb-key" onclick="kbAddKey('Esc')" style="font-size:9px">Esc</button>
        <button class="kb-key" onclick="kbAddKey('1')">1</button>
        <button class="kb-key" onclick="kbAddKey('2')">2</button>
        <button class="kb-key" onclick="kbAddKey('3')">3</button>
        <button class="kb-key" onclick="kbAddKey('4')">4</button>
        <button class="kb-key" onclick="kbAddKey('5')">5</button>
        <button class="kb-key" onclick="kbAddKey('6')">6</button>
        <button class="kb-key" onclick="kbAddKey('7')">7</button>
        <button class="kb-key" onclick="kbAddKey('8')">8</button>
        <button class="kb-key" onclick="kbAddKey('9')">9</button>
        <button class="kb-key" onclick="kbAddKey('0')">0</button>
        <button class="kb-key" onclick="kbAddKey('Backspace')" style="font-size:8px">BS</button>
      </div>
      <!-- Row: Tab, Q-P -->
      <div class="kb-row">
        <button class="kb-key" onclick="kbAddKey('Tab')" style="font-size:9px">Tab</button>
        <button class="kb-key" onclick="kbAddKey('Q')">Q</button>
        <button class="kb-key" onclick="kbAddKey('W')">W</button>
        <button class="kb-key" onclick="kbAddKey('E')">E</button>
        <button class="kb-key" onclick="kbAddKey('R')">R</button>
        <button class="kb-key" onclick="kbAddKey('T')">T</button>
        <button class="kb-key" onclick="kbAddKey('Y')">Y</button>
        <button class="kb-key" onclick="kbAddKey('U')">U</button>
        <button class="kb-key" onclick="kbAddKey('I')">I</button>
        <button class="kb-key" onclick="kbAddKey('O')">O</button>
        <button class="kb-key" onclick="kbAddKey('P')">P</button>
        <button class="kb-key" onclick="kbAddKey('Del')" style="font-size:9px">Del</button>
      </div>
      <!-- Row: Caps, A-L, Enter -->
      <div class="kb-row">
        <button class="kb-key" onclick="kbAddKey('Caps')" style="font-size:8px">Caps</button>
        <button class="kb-key" onclick="kbAddKey('A')">A</button>
        <button class="kb-key" onclick="kbAddKey('S')">S</button>
        <button class="kb-key" onclick="kbAddKey('D')">D</button>
        <button class="kb-key" onclick="kbAddKey('F')">F</button>
        <button class="kb-key" onclick="kbAddKey('G')">G</button>
        <button class="kb-key" onclick="kbAddKey('H')">H</button>
        <button class="kb-key" onclick="kbAddKey('J')">J</button>
        <button class="kb-key" onclick="kbAddKey('K')">K</button>
        <button class="kb-key" onclick="kbAddKey('L')">L</button>
        <button class="kb-key" onclick="kbAddKey('Enter')" style="flex:2;font-size:8px">Enter</button>
      </div>
      <!-- Row: Shift, Z-M, Ins -->
      <div class="kb-row">
        <button class="kb-key" onclick="kbAddKey('Shift')" style="flex:2;font-size:9px">Shift</button>
        <button class="kb-key" onclick="kbAddKey('Z')">Z</button>
        <button class="kb-key" onclick="kbAddKey('X')">X</button>
        <button class="kb-key" onclick="kbAddKey('C')">C</button>
        <button class="kb-key" onclick="kbAddKey('V')">V</button>
        <button class="kb-key" onclick="kbAddKey('B')">B</button>
        <button class="kb-key" onclick="kbAddKey('N')">N</button>
        <button class="kb-key" onclick="kbAddKey('M')">M</button>
        <button class="kb-key" onclick="kbAddKey('Ins')" style="font-size:9px">Ins</button>
        <button class="kb-key" onclick="kbRemoveLast()" style="color:#f87171;font-size:11px" title="Remove last">✕</button>
      </div>
      <!-- Row: Ctrl, Win, Alt, Space -->
      <div class="kb-row">
        <button class="kb-key" onclick="kbAddKey('Ctrl')" style="flex:2;font-size:9px">Ctrl</button>
        <button class="kb-key" onclick="kbAddKey('Win')" style="font-size:9px">Win</button>
        <button class="kb-key" onclick="kbAddKey('Alt')" style="font-size:9px">Alt</button>
        <button class="kb-key" onclick="kbAddKey('Space')" style="flex:5;font-size:9px">Space</button>
        <button class="kb-key" onclick="kbAddKey('Fn')" style="font-size:9px">Fn</button>
      </div>
      <!-- Row: F-keys -->
      <div class="kb-row">
        <button class="kb-key" onclick="kbAddKey('F1')" style="font-size:9px">F1</button>
        <button class="kb-key" onclick="kbAddKey('F2')" style="font-size:9px">F2</button>
        <button class="kb-key" onclick="kbAddKey('F3')" style="font-size:9px">F3</button>
        <button class="kb-key" onclick="kbAddKey('F4')" style="font-size:9px">F4</button>
        <button class="kb-key" onclick="kbAddKey('F5')" style="font-size:9px">F5</button>
        <button class="kb-key" onclick="kbAddKey('F6')" style="font-size:9px">F6</button>
        <button class="kb-key" onclick="kbAddKey('F7')" style="font-size:9px">F7</button>
        <button class="kb-key" onclick="kbAddKey('F8')" style="font-size:9px">F8</button>
        <button class="kb-key" onclick="kbAddKey('F9')" style="font-size:9px">F9</button>
        <button class="kb-key" onclick="kbAddKey('F10')" style="font-size:8px">F10</button>
        <button class="kb-key" onclick="kbAddKey('F11')" style="font-size:8px">F11</button>
        <button class="kb-key" onclick="kbAddKey('F12')" style="font-size:8px">F12</button>
      </div>
      <!-- Row: Nav / Arrows -->
      <div class="kb-row">
        <button class="kb-key" onclick="kbAddKey('PrtSc')" style="font-size:7px">PrtSc</button>
        <button class="kb-key" onclick="kbAddKey('Pause')" style="font-size:8px">Pause</button>
        <button class="kb-key" onclick="kbAddKey('Home')" style="font-size:8px">Home</button>
        <button class="kb-key" onclick="kbAddKey('End')" style="font-size:9px">End</button>
        <button class="kb-key" onclick="kbAddKey('PgUp')" style="font-size:8px">PgUp</button>
        <button class="kb-key" onclick="kbAddKey('PgDn')" style="font-size:8px">PgDn</button>
        <span style="flex:1"></span>
        <button class="kb-key" onclick="kbAddKey('Up')">↑</button>
        <span style="width:2px"></span>
        <button class="kb-key" onclick="kbAddKey('Left')">←</button>
        <button class="kb-key" onclick="kbAddKey('Down')">↓</button>
        <button class="kb-key" onclick="kbAddKey('Right')">→</button>
      </div>
    </div>
    <!-- Action buttons -->
    <div style="display:flex;gap:8px;justify-content:flex-end;align-items:center">
      <button class="modal-btn" style="background:#5a5a6a" onclick="kbCancel()"><span data-i18n="kb.cancel">キャンセル</span></button>
      <button class="modal-btn" style="background:#6b7280" onclick="kbClear()"><span data-i18n="kb.clear">クリア</span></button>
      <button class="modal-btn" style="background:#2563eb" onclick="kbApply()"><span data-i18n="kb.apply">適用</span></button>
      <button class="modal-btn" style="background:#16a34a" onclick="kbApplyNext()"><span data-i18n="kb.applyNext">適用して次へ</span></button>
    </div>
  </div>
</div>

<!-- Export Modal -->
<div class="modal-overlay" id="exportModal">
  <div class="modal-box" style="width:660px;max-height:85vh;display:flex;flex-direction:column">
    <div class="modal-title" data-i18n="exp.title">📄 チートシート出力</div>
    <div style="display:flex;gap:12px;margin-bottom:10px;flex-wrap:wrap">
      <label style="display:flex;align-items:center;gap:6px;font-size:13px">
        <span data-i18n="exp.columns">カラム数:</span>
        <select id="exportCols" onchange="updateExportPreview()" style="background:#12121f;color:#ddd;border:1px solid #444;border-radius:4px;padding:4px 8px">
          <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option>
        </select>
      </label>
      <label style="display:flex;align-items:center;gap:6px;font-size:13px">
        <span data-i18n="exp.fontSize">フォントサイズ:</span>
        <input type="number" id="exportFontSize" value="12" min="4" max="20" step="0.5" onchange="updateExportPreview()"
          style="background:#12121f;color:#ddd;border:1px solid #444;border-radius:4px;padding:4px 8px;width:60px"> pt
      </label>
      <label style="display:flex;align-items:center;gap:6px;font-size:13px">
        <span data-i18n="exp.buttonStyle">ボタン表示:</span>
        <select id="exportRenderMode" onchange="updateExportPreview()" style="background:#12121f;color:#ddd;border:1px solid #444;border-radius:4px;padding:4px 8px">
          <option value="promptfont" data-i18n="exp.promptfont">PromptFont（グリフ）</option>
          <option value="badge" data-i18n="exp.badge">テキストバッジ（CSS）</option>
        </select>
      </label>
    </div>
    <div id="fontSourceRow" style="display:flex;gap:12px;margin-bottom:10px">
      <label style="display:flex;align-items:center;gap:6px;font-size:13px">
        <span data-i18n="exp.fontSource">フォント参照先:</span>
        <select id="exportFontSource" onchange="updateExportPreview()" style="background:#12121f;color:#ddd;border:1px solid #444;border-radius:4px;padding:4px 8px">
          <option value="local" data-i18n="exp.fontLocal">ローカル（同フォルダ）</option>
          <option value="ghpages" data-i18n="exp.fontGhpages">GitHub Pages（URL参照）</option>
        </select>
      </label>
    </div>
    <div id="exportFilenameHint" style="font-size:11px;color:#888;margin-bottom:8px"></div>
    <div style="flex:1;overflow:auto;background:#fff;border-radius:6px;margin-bottom:12px;min-height:200px">
      <iframe id="exportPreview" style="width:100%;height:300px;border:none"></iframe>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
      <button class="modal-btn" style="background:#5a5a6a" onclick="closeExportModal()" data-i18n="exp.close">閉じる</button>
      <button class="modal-btn" style="background:#6b7280" onclick="openInNewTab()" data-i18n="exp.newTab">🔗 別タブで開く</button>
      <button class="modal-btn" style="background:#7c3aed" onclick="printCheatsheet()" data-i18n="exp.print">🖨 印刷</button>
      <button class="modal-btn" style="background:#2563eb" onclick="downloadHTML()" data-i18n="exp.saveHtml">💾 HTMLを保存</button>
    </div>
  </div>
</div>

<!-- Status Bar -->
<div id="status-bar">
  <span class="status-dot" id="gpDot" style="background:#666"></span>
  <span id="gpStatus" data-i18n="status.noController">コントローラー未接続</span>
  <span class="toolbar-spacer"></span>
  <span data-i18n="status.shortcuts">Ctrl+S: 保存 | Ctrl+Z: 元に戻す | 右クリック: メニュー</span>
</div>

<script src="app.js?v=3.0.0"></script>
</body>
</html>
