<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapping Manager</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="apple-touch-icon" href="favicon_180.png">
<link rel="stylesheet" href="style.css?v=1.2.0">
</head>
<body>

<!-- Header -->
<div id="header">
  <span class="app-title">🎮 Mapping Manager</span>
  <a href="https://github.com/Crowell7144/MappingManager" target="_blank" rel="noopener" class="github-link" title="GitHub Repository">
    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
      <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38
        0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13
        -.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66
        .07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15
        -.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27
        .68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12
        .51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48
        0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
    </svg>
  </a>
  <span class="filename" id="filenameDisplay" data-i18n-title="filename.tooltip" onclick="startFileNameEdit()" style="cursor:pointer">new_mapping.csv</span>
  <input type="text" id="filenameEdit" class="filename" style="display:none"
    onblur="finishFileNameEdit()" onkeydown="if(event.key==='Enter')this.blur();if(event.key==='Escape'){this.value=fileName;this.blur();}">
  <span class="toolbar-spacer"></span>
  <button class="toolbar-btn" onclick="handleNew()" data-i18n="btn.new">📄 新規</button>
  <div class="open-menu-wrap" id="openMenuWrap">
    <button class="toolbar-btn open-menu-trigger" id="openMenuBtn" onclick="toggleOpenMenu()" data-i18n="btn.open">📂 開く ▾</button>
    <div class="open-menu-dropdown" id="openMenuDropdown">
      <button class="open-menu-item" onclick="openMenuAction('csv')" data-i18n="btn.openCsv">📂 CSVファイルを開く</button>
      <button class="open-menu-item" onclick="openMenuAction('gist')" data-i18n="btn.gistLoad">🔗 Gistから読み込む</button>
      <div class="open-menu-sep"></div>
      <div id="openMenuSamples"><!-- dynamically built --></div>
    </div>
  </div>
  <button class="toolbar-btn" id="csvCopyBtn" onclick="copyCsvToClipboard('csvCopyBtn')" data-i18n="btn.copyCsv">📋 CSVコピー</button>
  <a id="saveCsvBtn" class="toolbar-btn accent" href="#" data-i18n="btn.saveCsv"
    onclick="handleSaveCSVClick(event)"
    onmouseenter="refreshSaveCsvHref()"
    oncontextmenu="refreshSaveCsvHref()">💾 CSV保存</a>
  <span class="toolbar-sep"></span>
  <button class="toolbar-btn accent2" onclick="showExportModal()" data-i18n="btn.export">📄 チートシート出力</button>
  <span class="toolbar-sep"></span>
  <button class="toolbar-btn" id="undoBtn" onclick="undo()" disabled data-i18n="btn.undo">↩ 元に戻す</button>
  <span class="toolbar-sep"></span>
  <select id="controllerSelect" onchange="switchController(this.value)">
    <option value="xbox">🎮 Xbox</option>
    <option value="ps4">🎮 PS4</option>
    <option value="ps5">🎮 PS5</option>
    <option value="switch">🎮 Switch</option>
  </select>
  <span class="toolbar-sep"></span>
  <button class="toolbar-btn" id="settingsBtn" onclick="openSettingsModal()" aria-label="設定">⚙</button>
  <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="handleOpenCSV(event)">
</div>

<!-- Column Headers -->
<div id="col-headers">
  <!-- ③ 出力列ヘッダー: 👁 → ☑（チェックボックスの意味に合わせて変更） -->
  <div class="col-output" data-i18n="col.output">☑</div>
  <div class="col-type" style="padding-left:28px" data-i18n="col.type">種別</div>
  <div class="col-name" data-i18n="col.name">名前</div>
  <div class="col-mapping" data-i18n="col.mapping">マッピング</div>
</div>

<!-- Item List -->
<div id="item-list"></div>

<!-- Add Buttons -->
<div id="add-bar">
  <button class="add-btn add-btn-mapping"   onclick="addItem('mapping')"   data-i18n="add.mapping">+ マッピング</button>
  <button class="add-btn add-btn-category"  onclick="addItem('category')"  data-i18n="add.category">+ カテゴリ</button>
  <button class="add-btn add-btn-separator" onclick="addItem('separator')" data-i18n="add.separator">+ セパレーター</button>
  <button class="add-btn add-btn-pagebreak" onclick="addItem('pagebreak')" data-i18n="add.pagebreak">+ 改ページ</button>
</div>

<!-- Context Menu -->
<div id="ctx-menu"></div>

<!-- Gamepad Input Modal -->
<div class="modal-overlay" id="gamepadModal">
  <div class="modal-box" style="min-width:420px;max-width:500px">
    <div class="modal-title" data-i18n="gp.title">🎮 コントローラ入力待機中</div>
    <div id="gamepadItemName" class="modal-item-name"></div>
    <div class="modal-hint-text" data-i18n="gp.currentMapping">現在のマッピング:</div>
    <div id="gamepadCurrentMapping" class="modal-current-mapping">
      <span class="empty-mapping-hint" data-i18n="gp.none">なし</span>
    </div>
    <div class="modal-subtitle" data-i18n="gp.instruction">コントローラーのボタンを押してください。同時押しに対応しています。</div>
    <div class="modal-paddle-hint" data-i18n-html="gp.paddleHint"></div>
    <div class="modal-hint-text" data-i18n="gp.newInput">新しい入力:</div>
    <div id="gamepadDisplay" class="modal-input-display">
      <span class="empty-state-text" data-i18n="gp.noInput">入力なし</span>
    </div>
    <div id="gamepadButtonGrid"></div>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-cancel" onclick="gamepadCancel()"><span data-i18n="gp.cancel">キャンセル</span> <kbd class="kbd-hint">Esc</kbd></button>
      <button class="modal-btn modal-btn-neutral" onclick="gamepadClear()"><span data-i18n="gp.clear">クリア</span></button>
      <button class="modal-btn modal-btn-skip" onclick="gamepadSkipNext()"><span data-i18n="gp.skip">次へ</span> <kbd class="kbd-hint">Tab</kbd></button>
      <button class="modal-btn modal-btn-primary" onclick="gamepadApply()"><span data-i18n="gp.apply">適用</span> <kbd class="kbd-hint">Enter</kbd></button>
      <button class="modal-btn modal-btn-apply-next" onclick="gamepadApplyNext()"><span data-i18n="gp.applyNext">適用して次へ</span> <kbd class="kbd-hint">Space</kbd></button>
    </div>
  </div>
</div>

<!-- Keyboard Input Modal -->
<div class="modal-overlay" id="keyboardModal">
  <div class="modal-box" style="min-width:520px;max-width:600px">
    <div class="modal-title" data-i18n="kb.title">⌨️ キーボード入力</div>
    <div id="kbItemName" class="modal-item-name-kb"></div>
    <div class="modal-hint-text" data-i18n="kb.currentMapping">現在のマッピング:</div>
    <div id="kbCurrentMapping" class="modal-current-mapping-kb">
      <span class="empty-mapping-hint" data-i18n="kb.none">なし</span>
    </div>
    <!-- New Input Display -->
    <div class="modal-hint-text" data-i18n="kb.newInput">新しい入力:</div>
    <div id="kbDisplay" class="modal-input-display-kb">
      <span class="empty-state-text" data-i18n="kb.noInput">入力なし</span>
    </div>
    <!-- Tab switch -->
    <div class="kb-tabs">
      <button class="kb-tab active" id="kbTabKeys" onclick="switchKbTab('keys')" data-i18n="kb.tabKeys">キー</button>
      <button class="kb-tab" id="kbTabSymbols" onclick="switchKbTab('symbols')" data-i18n="kb.tabSymbols">記号</button>
    </div>
    <!-- Key grid -->
    <div id="kb-panel-keys" style="display:flex;flex-direction:column;gap:3px;margin-bottom:10px">
      <!-- Row: Esc, Numbers, BS -->
      <div class="kb-row">
        <button class="kb-key" onclick="kbAddKey('Esc')" style="font-size:9px">Esc</button>
        <button class="kb-key" onclick="kbAddKey('1')">1</button>
        <button class="kb-key" onclick="kbAddKey('2')">2</button>
        <button class="kb-key" onclick="kbAddKey('3')">3</button>
        <button class="kb-key" onclick="kbAddKey('4')">4</button>
        <button class="kb-key" onclick="kbAddKey('5')">5</button>
        <button class="kb-key" onclick="kbAddKey('6')">6</button>
        <button class="kb-key" onclick="kbAddKey('7')">7</button>
        <button class="kb-key" onclick="kbAddKey('8')">8</button>
        <button class="kb-key" onclick="kbAddKey('9')">9</button>
        <button class="kb-key" onclick="kbAddKey('0')">0</button>
        <button class="kb-key" onclick="kbAddKey('Backspace')" style="font-size:8px">BS</button>
      </div>
      <!-- Row: Tab, Q-P -->
      <div class="kb-row">
        <button class="kb-key" onclick="kbAddKey('Tab')" style="font-size:9px">Tab</button>
        <button class="kb-key" onclick="kbAddKey('Q')">Q</button>
        <button class="kb-key" onclick="kbAddKey('W')">W</button>
        <button class="kb-key" onclick="kbAddKey('E')">E</button>
        <button class="kb-key" onclick="kbAddKey('R')">R</button>
        <button class="kb-key" onclick="kbAddKey('T')">T</button>
        <button class="kb-key" onclick="kbAddKey('Y')">Y</button>
        <button class="kb-key" onclick="kbAddKey('U')">U</button>
        <button class="kb-key" onclick="kbAddKey('I')">I</button>
        <button class="kb-key" onclick="kbAddKey('O')">O</button>
        <button class="kb-key" onclick="kbAddKey('P')">P</button>
        <button class="kb-key" onclick="kbAddKey('Del')" style="font-size:9px">Del</button>
      </div>
      <!-- Row: Caps, A-L, Enter -->
      <div class="kb-row">
        <button class="kb-key" onclick="kbAddKey('Caps')" style="font-size:8px">Caps</button>
        <button class="kb-key" onclick="kbAddKey('A')">A</button>
        <button class="kb-key" onclick="kbAddKey('S')">S</button>
        <button class="kb-key" onclick="kbAddKey('D')">D</button>
        <button class="kb-key" onclick="kbAddKey('F')">F</button>
        <button class="kb-key" onclick="kbAddKey('G')">G</button>
        <button class="kb-key" onclick="kbAddKey('H')">H</button>
        <button class="kb-key" onclick="kbAddKey('J')">J</button>
        <button class="kb-key" onclick="kbAddKey('K')">K</button>
        <button class="kb-key" onclick="kbAddKey('L')">L</button>
        <button class="kb-key" onclick="kbAddKey('Enter')" style="flex:2;font-size:8px">Enter</button>
      </div>
      <!-- Row: LShift, Shift, RShift, Z-M -->
      <div class="kb-row">
        <button class="kb-key" onclick="kbAddKey('LShift')" style="font-size:8px">L⇧</button>
        <button class="kb-key" onclick="kbAddKey('Shift')" style="font-size:9px">Shift</button>
        <button class="kb-key" onclick="kbAddKey('RShift')" style="font-size:8px">R⇧</button>
        <button class="kb-key" onclick="kbAddKey('Z')">Z</button>
        <button class="kb-key" onclick="kbAddKey('X')">X</button>
        <button class="kb-key" onclick="kbAddKey('C')">C</button>
        <button class="kb-key" onclick="kbAddKey('V')">V</button>
        <button class="kb-key" onclick="kbAddKey('B')">B</button>
        <button class="kb-key" onclick="kbAddKey('N')">N</button>
        <button class="kb-key" onclick="kbAddKey('M')">M</button>
        <button class="kb-key kb-key-remove" onclick="kbRemoveLast()" style="font-size:11px" title="Remove last">✕</button>
      </div>
      <!-- Row: LCtrl, Ctrl, RCtrl, LAlt, Alt, RAlt, Space, Win, Fn -->
      <div class="kb-row">
        <button class="kb-key" onclick="kbAddKey('LCtrl')" style="font-size:8px">L⌃</button>
        <button class="kb-key" onclick="kbAddKey('Ctrl')" style="font-size:9px">Ctrl</button>
        <button class="kb-key" onclick="kbAddKey('RCtrl')" style="font-size:8px">R⌃</button>
        <button class="kb-key" onclick="kbAddKey('LAlt')" style="font-size:8px">L⎇</button>
        <button class="kb-key" onclick="kbAddKey('Alt')" style="font-size:9px">Alt</button>
        <button class="kb-key" onclick="kbAddKey('RAlt')" style="font-size:8px">R⎇</button>
        <button class="kb-key" onclick="kbAddKey('Space')" style="flex:3;font-size:9px">Space</button>
        <button class="kb-key" onclick="kbAddKey('Win')" style="font-size:9px">Win</button>
        <button class="kb-key" onclick="kbAddKey('Fn')" style="font-size:9px">Fn</button>
      </div>
      <!-- Row: F-keys -->
      <div class="kb-row">
        <button class="kb-key" onclick="kbAddKey('F1')" style="font-size:9px">F1</button>
        <button class="kb-key" onclick="kbAddKey('F2')" style="font-size:9px">F2</button>
        <button class="kb-key" onclick="kbAddKey('F3')" style="font-size:9px">F3</button>
        <button class="kb-key" onclick="kbAddKey('F4')" style="font-size:9px">F4</button>
        <button class="kb-key" onclick="kbAddKey('F5')" style="font-size:9px">F5</button>
        <button class="kb-key" onclick="kbAddKey('F6')" style="font-size:9px">F6</button>
        <button class="kb-key" onclick="kbAddKey('F7')" style="font-size:9px">F7</button>
        <button class="kb-key" onclick="kbAddKey('F8')" style="font-size:9px">F8</button>
        <button class="kb-key" onclick="kbAddKey('F9')" style="font-size:9px">F9</button>
        <button class="kb-key" onclick="kbAddKey('F10')" style="font-size:8px">F10</button>
        <button class="kb-key" onclick="kbAddKey('F11')" style="font-size:8px">F11</button>
        <button class="kb-key" onclick="kbAddKey('F12')" style="font-size:8px">F12</button>
      </div>
      <!-- Row: Nav / Arrows -->
      <div class="kb-row">
        <button class="kb-key" onclick="kbAddKey('PrtSc')" style="font-size:7px">PrtSc</button>
        <button class="kb-key" onclick="kbAddKey('Pause')" style="font-size:8px">Pause</button>
        <button class="kb-key" onclick="kbAddKey('Home')" style="font-size:8px">Home</button>
        <button class="kb-key" onclick="kbAddKey('End')" style="font-size:9px">End</button>
        <button class="kb-key" onclick="kbAddKey('PgUp')" style="font-size:8px">PgUp</button>
        <button class="kb-key" onclick="kbAddKey('PgDn')" style="font-size:8px">PgDn</button>
        <span style="flex:1"></span>
        <button class="kb-key" onclick="kbAddKey('Up')">↑</button>
        <span style="width:2px"></span>
        <button class="kb-key" onclick="kbAddKey('Left')">←</button>
        <button class="kb-key" onclick="kbAddKey('Down')">↓</button>
        <button class="kb-key" onclick="kbAddKey('Right')">→</button>
      </div>
    </div>
    <!-- Symbol grid -->
    <div id="kb-panel-symbols" style="display:none;flex-direction:column;gap:3px;margin-bottom:10px">
      <!-- Row: 数字行記号 / Number-row symbols -->
      <div class="kb-row">
        <button class="kb-key" onclick="kbAddKey('!')">!</button>
        <button class="kb-key" onclick="kbAddKey('@')">@</button>
        <button class="kb-key" onclick="kbAddKey('#')">#</button>
        <button class="kb-key" onclick="kbAddKey('$')">$</button>
        <button class="kb-key" onclick="kbAddKey('%')">%</button>
        <button class="kb-key" onclick="kbAddKey('^')">^</button>
        <button class="kb-key" onclick="kbAddKey('&amp;')">&amp;</button>
        <button class="kb-key" onclick="kbAddKey('*')">*</button>
        <button class="kb-key" onclick="kbAddKey('(')">(</button>
        <button class="kb-key" onclick="kbAddKey(')')">)</button>
        <button class="kb-key" onclick="kbAddKey('-')">-</button>
        <button class="kb-key" onclick="kbAddKey('_')">_</button>
        <button class="kb-key" onclick="kbAddKey('=')">=</button>
        <button class="kb-key" onclick="kbAddKey('+')">+</button>
      </div>
      <!-- Row: 括弧・区切り / Brackets & delimiters -->
      <div class="kb-row">
        <button class="kb-key" onclick="kbAddKey('[')">[ <span style="font-size:7px;opacity:0.6">[ ]</span></button>
        <button class="kb-key" onclick="kbAddKey(']')">]</button>
        <button class="kb-key" onclick="kbAddKey('{')">{ <span style="font-size:7px;opacity:0.6">{ }</span></button>
        <button class="kb-key" onclick="kbAddKey('}')">}</button>
        <button class="kb-key" onclick="kbAddKey('&lt;')">&lt;</button>
        <button class="kb-key" onclick="kbAddKey('&gt;')">&gt;</button>
        <button class="kb-key" onclick="kbAddKey('\\')">\ </button>
        <button class="kb-key" onclick="kbAddKey('|')">|</button>
        <button class="kb-key" onclick="kbAddKey('/')">/ </button>
        <button class="kb-key" onclick="kbAddKey('~')">~</button>
        <button class="kb-key" onclick="kbAddKey('`')">`</button>
      </div>
      <!-- Row: 句読点 / Punctuation -->
      <div class="kb-row">
        <button class="kb-key" onclick="kbAddKey(';')">;</button>
        <button class="kb-key" onclick="kbAddKey(':')">:</button>
        <button class="kb-key" onclick="kbAddKey(&quot;'&quot;)">'</button>
        <button class="kb-key" onclick='kbAddKey("&quot;')">"</button>
        <button class="kb-key" onclick="kbAddKey(',')"> ,</button>
        <button class="kb-key" onclick="kbAddKey('.')">.</button>
        <button class="kb-key" onclick="kbAddKey('?')">?</button>
        <span style="flex:3"></span>
        <button class="kb-key kb-key-remove" onclick="kbRemoveLast()" style="font-size:11px" title="Remove last">✕</button>
      </div>
    </div>
    <!-- Action buttons -->
    <div class="modal-actions">
      <button class="modal-btn modal-btn-cancel" onclick="kbCancel()"><span data-i18n="kb.cancel">キャンセル</span> <kbd class="kbd-hint">Esc</kbd></button>
      <button class="modal-btn modal-btn-neutral" onclick="kbClear()"><span data-i18n="kb.clear">クリア</span></button>
      <button class="modal-btn modal-btn-skip" onclick="kbSkipNext()"><span data-i18n="kb.skip">次へ</span> <kbd class="kbd-hint">Tab</kbd></button>
      <button class="modal-btn modal-btn-primary" onclick="kbApply()"><span data-i18n="kb.apply">適用</span> <kbd class="kbd-hint">Enter</kbd></button>
      <button class="modal-btn modal-btn-apply-next" onclick="kbApplyNext()"><span data-i18n="kb.applyNext">適用して次へ</span> <kbd class="kbd-hint">Space</kbd></button>
    </div>
  </div>
</div>

<!-- Export Modal -->
<div class="modal-overlay" id="exportModal">
  <div class="modal-box" style="width:min(900px,92vw);max-height:90vh;display:flex;flex-direction:column">
    <div class="modal-title" data-i18n="exp.title">📄 チートシート出力</div>
    <div style="display:flex;gap:12px;margin-bottom:10px;flex-wrap:wrap">
      <label style="display:flex;align-items:center;gap:6px;font-size:13px">
        <span data-i18n="exp.columns">カラム数:</span>
        <input type="number" id="exportCols" value="3" min="1" max="6" step="1" oninput="updateExportPreview()"
          class="export-control number-input">
      </label>
      <label style="display:flex;align-items:center;gap:6px;font-size:13px">
        <span data-i18n="exp.fontSize">フォントサイズ:</span>
        <input type="number" id="exportFontSize" value="12" min="4" max="20" step="0.5" onchange="updateExportPreview()"
          class="export-control number-input"> pt
      </label>
      <label style="display:flex;align-items:center;gap:6px;font-size:13px">
        <span data-i18n="exp.buttonStyle">ボタン表示:</span>
        <select id="exportRenderMode" onchange="updateExportPreview()" class="export-control">
          <option value="promptfont" data-i18n="exp.promptfont">PromptFont（グリフ）</option>
          <option value="badge" data-i18n="exp.badge">テキストバッジ（CSS）</option>
        </select>
      </label>
      <label style="display:flex;align-items:center;gap:6px;font-size:13px">
        <span data-i18n="exp.theme">スタイル:</span>
        <select id="exportTheme" onchange="updateExportPreview()" class="export-control">
          <option value="mono" data-i18n="exp.themeMono">モノクロ</option>
          <option value="navy" data-i18n="exp.themeNavy">ネイビー</option>
          <option value="recommended" data-i18n="exp.themeRecommended">推奨設定</option>
        </select>
      </label>
    </div>
    <!-- 推奨値を適用ボタン (メタブロックがある場合のみ表示) -->
    <div id="exportRecommendedRow" style="display:none;align-items:center;gap:10px;margin-bottom:8px;font-size:13px">
      <button class="modal-btn modal-btn-apply-recommended" onclick="applyRecommendedToExport()" data-i18n="meta.applyRecommended">推奨値を適用</button>
    </div>
    <div id="fontSourceRow" style="display:flex;gap:12px;margin-bottom:10px">
      <label style="display:flex;align-items:center;gap:6px;font-size:13px">
        <span data-i18n="exp.fontSource">フォント参照先:</span>
        <select id="exportFontSource" onchange="updateExportPreview()" class="export-control">
          <option value="ghpages" data-i18n="exp.fontGhpages">GitHub Pages（URL参照）</option>
          <option value="local" data-i18n="exp.fontLocal">ローカル（同フォルダ）</option>
        </select>
      </label>
    </div>
    <div id="exportFilenameHint" class="modal-hint-text" style="margin-bottom:8px"></div>
    <div id="exportPreviewWrapper" class="export-preview-wrapper">
      <div id="exportPreviewScaler" class="export-preview-scaler">
        <iframe id="exportPreview" style="border:none;display:block;width:100%;min-height:400px"></iframe>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
      <button class="modal-btn modal-btn-save-meta" onclick="saveRecommendedSettings()" data-i18n="meta.saveRecommended">推奨設定を保存する</button>
      <button class="modal-btn modal-btn-cancel" onclick="closeExportModal()" data-i18n="exp.close">閉じる</button>
      <button class="modal-btn modal-btn-neutral" onclick="openInNewTab()" data-i18n="exp.newTab">🔗 別タブで開く</button>
      <button class="modal-btn modal-btn-export" onclick="printCheatsheet()" data-i18n="exp.print">🖨 印刷</button>
      <button class="modal-btn modal-btn-primary" onclick="downloadHTML()" data-i18n="exp.saveHtml">💾 HTMLを保存</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal" onclick="handleSettingsOverlayClick(event)">
  <div class="modal-box" style="min-width:300px;max-width:340px">
    <div class="modal-title" data-i18n="settings.title">⚙ 設定</div>
    <div class="settings-section">
      <div class="settings-label" data-i18n="settings.theme">テーマ</div>
      <div class="segment-control" id="themeSegment">
        <button class="segment-btn" data-value="dark" onclick="applyThemeAndSave('dark')" data-i18n="settings.theme.dark">🌙 ダーク</button>
        <button class="segment-btn" data-value="light" onclick="applyThemeAndSave('light')" data-i18n="settings.theme.light">☀️ ライト</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-label" data-i18n="settings.lang">言語 / Language</div>
      <div class="segment-control" id="langSegment">
        <button class="segment-btn" data-value="ja" onclick="setLang('ja')">日本語</button>
        <button class="segment-btn" data-value="en" onclick="setLang('en')">English</button>
      </div>
    </div>
    <div class="modal-actions" style="margin-top:4px">
      <button class="modal-btn modal-btn-cancel" onclick="closeSettingsModal()" data-i18n="settings.close">閉じる</button>
    </div>
  </div>
</div>

<!-- Status Bar -->
<div id="status-bar">
  <span class="status-dot" id="gpDot" style="background:var(--text-disabled)"></span>
  <span id="gpStatus" data-i18n="status.noController">コントローラー未接続</span>
  <span class="toolbar-spacer"></span>
  <span data-i18n="status.shortcuts">Ctrl+S: 保存 | Ctrl+Z: 元に戻す | 右クリック: メニュー</span>
</div>

<!-- Gist Load Dialog -->
<div class="modal-overlay" id="gistModal">
  <div class="modal-box" style="min-width:480px;max-width:560px">
    <div class="modal-title" data-i18n="gist.title">🔗 Gist読込</div>
    <input type="text" id="gistUrlInput" class="gist-url-input" data-i18n-placeholder="gist.placeholder">
    <div id="gistDialogError" class="gist-error" style="display:none"></div>
    <div id="gistDialogLoading" class="gist-loading" style="display:none" data-i18n="gist.loading">読み込み中...</div>
    <div class="modal-actions" style="margin-top:10px;margin-bottom:16px">
      <button class="modal-btn modal-btn-cancel" onclick="closeGistDialog()" data-i18n="gist.cancel">キャンセル</button>
      <button class="modal-btn modal-btn-primary" onclick="handleGistLoad()" data-i18n="gist.load">読み込む</button>
    </div>
    <div class="gist-share-section">
      <div class="gist-share-section-title" data-i18n="gist.shareTitle">📤 現在のデータをGistで共有するには</div>
      <ol class="gist-steps">
        <li data-i18n="gist.step1">「📋 CSVコピー」ボタンでデータをコピー</li>
        <li><a href="https://gist.github.com" target="_blank" rel="noopener" data-i18n="gist.step2link">gist.github.com</a><span data-i18n="gist.step2rest"> でCSVを貼り付けてCreate Gistで保存</span></li>
        <li data-i18n="gist.step3">GistのURLをコピーして上の入力欄に貼り付けて読み込む</li>
        <li data-i18n="gist.step4">完了画面に表示される共有URLを相手に送る</li>
      </ol>
      <button class="toolbar-btn" id="gistDialogCopyBtn" onclick="copyCsvToClipboard('gistDialogCopyBtn')" data-i18n="btn.copyCsv">📋 CSVコピー</button>
    </div>
  </div>
</div>

<!-- Gist Success Modal -->
<div class="modal-overlay" id="gistSuccessModal">
  <div class="modal-box" style="min-width:420px;max-width:540px">
    <div class="modal-title" data-i18n="gist.successTitle">✅ 読み込み完了</div>
    <p class="gist-success-msg" data-i18n="gist.successMsg">データを読み込みました。以下のURLで共有できます：</p>
    <div class="gist-share-url-box">
      <span id="gistShareUrlText" class="gist-share-url-text"></span>
    </div>
    <div class="modal-actions" style="margin-top:14px">
      <button class="modal-btn modal-btn-neutral" id="gistShareCopyBtn" onclick="copyGistShareUrl()" data-i18n="gist.copyUrl">📋 URLをコピー</button>
      <button class="modal-btn modal-btn-primary" onclick="closeGistSuccessModal()" data-i18n="gist.close">閉じる</button>
    </div>
  </div>
</div>

<script src="app.js"></script>
</body>
</html>
